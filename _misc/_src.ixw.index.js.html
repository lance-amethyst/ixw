<script>
var isFoundInArray = IX.Array.isFound;
var ixwPages = IXW.Pages;
var ixwActions = IXW.Actions;

</script>
<tpl id="page">
	<nav class="navbar navbar-default navbar-fixed-top">
		<div class="container-fluid">
			<div class="navbar-header">
				<a href="#"><span class="pic-badges"></span><span class="navbar-brand">Project Name</span></a>
			</div>
			<div class="navbar-collapse collapse">
				<ul class="nav navbar-nav"><tpl id="nav">
					<li id="nav-{name}" class="{clz}"><a href="#{href}">{text}</a></li>
				</tpl></ul>
				<ul class="nav navbar-nav navbar-right">
					<li id="nav-profile" ><a data="#profile">
						<span class="pic-avatar"></span><span>{username}</span>
					</a></li>
					<li><a data-href="$logout" ><span>退出</span></a></li>
				</ul>
			</div>
		</div>
	</nav>
	<div class="container">
		<div id="topbar"></div>
		<div id="body"></div>
	</div>
</tpl>
<script>

function SessionManager(data){
	var sessionData = data;
	var userName = $XP(data, "name", "");
	var userId = $XP(data, "id", null);
	var enabledModules = $XP(data, "modules", []);

	return {
		hasAuth : function(){return userId !== null;},
		getUserName : function(){return userName;},
		getUserId : function(){return userId;},
		checkIfModuleEnabled : function(module){ return isFoundInArray(module, enabledModules);}
	};
}
var sessionMgr = new SessionManager();

var NavItems = [
//["home", "首页"],
["moduleA", "模块A"],
["moduleB", "模块B"]
];
var DefaultNav = "home"
function NavManager(focusedNavName){
	var focused = focusedNavName || DefaultNav;

	function _getNavItemTplData(name, item){
		return {
			name : name,
			text : item[1],
			clz : focused == name ? "active": "",
			href: ixwPages.createPath(name)
		};
	}
	function _focus(itemName){
		var el = $X('nav-' + itemName);
		if (itemName != focused && el){
			$XH.removeClass($X("nav-" + focused), "active");
			focused = itemName;
		}
		$XH.addClass(el, "active");
	}
	return {
		getRenderData : function(){ return IX.loop(NavItems, [], function loopNavItem(acc, item){
			var name = item[0];
			if (/*name == "home" ||*/ sessionMgr.checkIfModuleEnabled(name))
				acc.push(_getNavItemTplData(name, item));
			return acc;
		});},
		focus : _focus
	};
}
var navMgr = new NavManager();

function clearSession(){
	sessionMgr = new SessionManager();
	IXW.Pages.load("entry");
}
function startSession(data){
	sessionMgr = new SessionManager(data);
	document.body.innerHTML = t_page.renderData("",{
		nav : navMgr.getRenderData(),
		username : data.name
	});
}
var PagesConfiurations = IX.map([
//{type?, name+, path?, bodyClz?, needAuth?},
{type: "ErrPage", name: "401", needAuth : false},
{type: "ErrPage", name: "404", needAuth : false},
//{name: "home", path: "home"},

{type : "ModuleA", name: "moduleA", isDefault : true},

{type : "ModuleA", name: "moduleB"},
{type : "ModuleA", name: "moduleB-sub", path : "moduleB/{subId}"},

{name: "entry", bodyClz: "entry", needAuth : false}
], function(item){
	var name = item.name;
	var moduleName = name.split("-")[0];
	var className = item.type || moduleName.capitalize();
	return IX.inherit({
		initiator : "{NS}." + className + ".init",
		path : name,

		nav : "service",
		navItem : moduleName,

		needAuth : true
	}, item);
});

ixwActions.configActions([["logout", function(){
	if (!window.confirm("确认是否退出?"))
		return;
	{NS}.Global.entryCaller("logout", {}, function(){
		clearSession();
	});
}]]);

function loadSession(pageFn){
	{NS}.Global.commonCaller("session", {}, function(data){
		if (!data || !data.id)
			return ixwPages.load("entry");
		startSession(data);
		pageFn();
	});
}

IX.ns("{NS}.Env");
{NS}.Env.init = function(){
	ixwPages.listenOnClick(document.body);
	ixwPages.configPages(PagesConfiurations, function(pageName, pageCfg){
		return !$XP(pageCfg, "needAuth", true) || sessionMgr.hasAuth();
	});

	IXW.Navs.register("service", function(cfg){
		navMgr.focus(cfg.navItem || "");
	});
	loadSession(function(){
		ixwPages.start();
	});
};
{NS}.Env.isMe = function(userId){return userId === sessionMgr.getUserId();};
{NS}.Env.reloadSession = function(){
	loadSession(function(){
		ixwPages.reload();
	});
};
{NS}.Env.clearSession = clearSession;
{NS}.Env.hasSession = function(){return sessionMgr.hasAuth();};
{NS}.Env.resetSession = function(data){startSession(data);};

var appInitialized = false;
{NS}.init = function(){
	if (appInitialized)
		return;
	appInitialized = true;
	{NS}.Env.init();
};
</script>
